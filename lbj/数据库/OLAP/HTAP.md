# HTAP

## OLTP(On-Line Transaction Procession)

基本特征是前台接受的用户数据可以立即传送到计算中心进行处理，并在很短的时间内给出处理结果，是对用户操作快速响应的方式之一，一般指传统的关系型数据库。
## OLAP

一般指仓库型数据库，主要读取数据，做复杂数据分析、侧重技术决策支持，提供直观简单的结果。
###OLAP场景的关键特征
* 绝大多数是读请求
* 数据以相当大的批次(>1000行)更新，而不是单行更新或者根本没更新
* 已添加到数据库的数据不能修改(<s>啥意思，为啥感觉跟上一条有冲突</s>更新与修改不同，更新是指数据库引擎采用自己的策略选择范围进行更新，修改是指用户自己手动修改数据)
* 宽表，即每个表包含着大量的列，对于读取，从数据库中提取相当多的行，但只提取列的一小部分
* 对于简单查询，允许延迟大约50ms(这个是上限的意思还是下限的意思？)
* 对事物要求不高，一致性要求低(意思是可能不准的意思吗？)
* 查询较少(通常每台服务器每秒查询数百次或更少)，但单个查询却需要高吞吐量(每台服务器每秒可达数十亿行)

### I/O的优化

首先针对分析类查询，通常只需要读取表的小部分列，这样就可以减少无用数据的读取。其次数据按列读取，按列存储，相同类型的数据更容易被压缩，这样进一步减少了I/O的次数。

###CPU的优化
由于执行一个查询需要处理大量的行，因此在整个向量上执行所有操作将比在每一行上执行所有操作更加高效。(卧槽，又是不懂的概念。)且这将有助于实现一个几乎没有调用成本的查询引擎，如果不这样做将导致查询引擎不可避免的停止cpu进行等待，所以按列存储数据且按列执行是很有意义的。(懵～～～)  
实现方法：

1. 向量引擎：所有的操作都是为向量而不是为单个值编写的。这意味着多个操作之间不再需要频繁的调用，并且调用的成本基本可以忽略不计。操作代码包含一个优化的内部循环。(此处也不懂，大概就是使用向量引擎的意思？)
2. 代码生成：生成一段代码，包含查询中的所有操作(啥意思？即我们自己去规划怎么去访问存储空间，怎么去拿数据)

因为这在运行简单查询时是没有意义的，所以这不应该在通用数据库中实现。为了提高CPU效率，查询语言必须是[声明式语言](https://www.zhihu.com/question/22285830)(通俗来讲就是更接近人类语言的我要做什么，而不是具体的顺序+分支+循环的做流程)，如SQL或MDX，或者至少一个向量(a,b)。查询应该只包含隐式循环，允许进行优化。
### [ClickHouse](https://clickhouse.tech/docs/zh/)

#### 特性

1. 紧凑的数据：列式数据库管理系统应该除了数据本身外不存储其他额外的数据，即采用紧凑的方式存储数据而不应该在值旁边存储它们的长度，如果不是这样将对cpu的使用产生强烈影响(是指需要花费额外的cpu时间去处理分析数值长度的逻辑？)。
2. 数据压缩：除了选择在磁盘空间和CPU消耗之间进行不同权衡的高效通用压缩编解码器，还针对特定类型数据的专用编解码器使得ClickHouse能与更小的数据库(时间序列数据库)的竞争中超越它们。
3. 数据的磁盘存储：许多列式数据库只能在内存中工作，这种方式会造成比实际更多的设备预算。ClickHouse被设计工作在传统磁盘上，提供更低的存储成本，但如果可以使用SSD和内存它也会合理利用这些资源。(此处是考虑到列式存储通常都是用于存储大量数据，存储代价较大？而且采用分布式解决，通讯成本，解决方案也会比较高昂吧。而且有一点比较关键，列式是高吞吐低并发，需要一次性处理更多的数据然后与外部交互而不是多次与外部交互给很多的数据)
4. 分布式处理：一般的列式数据库不支持分布式的查询处理。(按理来说分布式挺重要的，为什么都不支持呢？)ClickHouse将数据保存在不同的shard上，每个shard都有容错备份的replica组成，查询并行的在shard上进行对用户是透明的。使用异步的多主复制技术，保证系统在不同副本上保持相同的数据。
5. 向量引擎：数据不仅仅按列存储，同时还按向量(列的一部分)进行处理，这样更加高效的使用CPU(说起这个，我倒想起并行计算加速，使用多核的计算算法交叉计算向量数据最后合并结果，这里应该也是这个意思吧？)
6. 实时数据更新：为支持范围查找数据总是以增量的方式有序的存储在MergeTree(和B+树的区别在哪儿？是否跟时序数据库很像呢？)中。数据可以持续不断高效的写入到表中，并且写入的过程中不会存在任何加锁行为。(这块是因为抛弃了用户的update/delete行为吗）
7. 支持近似计算：1.用于近似计算的各类聚合函数，如：`distinct value`,`medians`,`quantiles`。2.基于数据的部分样本进行近似查询。(最简单的理解就是抽样调查)3.不使用全部的聚合条件，随机选择有限个聚合条件进行聚合，这在某些分布条件下提供准确的聚合结果又同时降低了计算资源的使用。(相当于引擎帮你去掉聚合函数的冗余计算？)
8. 适用于连接算法：在自定义join多个表时，倾向使用散列连接算法，如果有多个大表则使用合并-连接算法。(这些算法统统不懂！！！)
9. 角色的访问控制

#### 限制

1. 没有完整事务支持
2. 缺少高频率，低延迟的修改删除已存在数据的能力，仅能用于批量删除或修改数据。(额。。现在又可以删除数据了吗，此处的批量是否是有考虑稀疏索引的原因？)
3. 稀疏索引使得ClickHouse不适合通过其键检索单行的点查询。(<s>不适合应该指，能做到但是不便利，即比较慢？稀疏索引，我去，为什么不懂是啥？</s>[稀疏索引及mysql](#120.1))

#### 性能

吞吐量：可以使用每秒处理的行数或每秒处理的字节数来衡量。如果数据放置在page cache中，则一个不复杂查询在单个服务器上能够以2-10GB/s的速度处理，如果是简单查询可以达到30GB/s(未压缩的数据)。如果数据没在page cache中，则速度取决于压缩率，一般磁盘允许400MB/s的速度读取速度。对于分布式处理，处理速度是线性扩展的，受限于聚合或排序的结果不是那么大(这块内容还是不太理解，为什么受限？)。(对于传统数据库的落盘一般是directIO，由自己控制刷盘逻辑防止丢失数据。读的话我感觉应该还是走操作系统那套缓存流程，目前没发现有什么特殊需求。)

短查询延迟时间：普通查询使用主键且没有太多行(几十行)进行处理，没有查询太多列，数据有被page cache缓存延迟应该小于50ms(最优的情况下小于10ms)。如果使用的HDD(机械硬盘)，在数据没有预加载的情况下，查询所需的时间延迟可通过一下公式计算出:`查找时间(10ms)*查询列数*查询的数据块的数量`(所以数据块数量是什么意思？)

处理大量短查询的吞吐量：一般情况下ClickHouse可以在单台服务器上每秒处理数百个查询，但这不适合此数据库的业务场景，建议每秒查询次数不超过100。

数据的写入性能：建议每次写入不少于1k行的批量写入或每秒不超过1个写入请求。当使用tab-separated格式写入MergeTree表中时，写入速度大约为50-200MB/s。为了提高写入性能，也可以使用并行insert数据。(写应该是直写)

## [相关SQL语法](https://clickhouse.tech/docs/zh/sql-reference/statements/create/)

## <div id = 120.1>稀疏索引及mysql</div>

密集索引：文件中的每个搜索码值都对应一个索引值(一对一)
稀疏：索引文件只为索引码的某些值建立索引(一对多，因为是按顺序排列的所以可以按区间建立索引)
myisam的所有索引都是稀疏索引，innodb有且只有一个密集索引，非聚簇索引都是稀疏索引。(<font color="#ff00ff">网上文章不靠谱，还是回去慢慢翻翻高性能mysql第五章吧</font>)