# 最佳实践

## 一致性标准

### 最高标准

状态机集群管理数据流，监督数据状态变化，回滚

### 高一致性标准

使用事务消息，mysql使用事务，并且事务消息在mysql提交后提交。

优点:之所以事务消息后提交，是因为事务消息补偿逻辑可控，mysql崩溃后，重启后自动回滚未完成事务，不好控制。事务消息，broker会定期检查几次回调函数，可以设置补偿逻辑。且就算因为崩溃时间过长错过了补偿时期，相关消息也会存放对应特殊队列，不会消失，容错性高。

### 一般一致性标准

mysql使用事务，在提交前发送一条普通消息。

缺点：之所以在提交前发送一条普通消息，是因为中间发送，服务崩溃的窗口期更大。该问题本质就是，消息发送了，mysql commit失败了，或者在commit前崩溃了，mysql重启回滚事务，但消息不会回滚。

消费消息的消息为mysql的bin log。即等同与mysql使用事务完成任务后，再发送一条普通消息。

缺点：bin log保证了mysql确实任务执行成功了，再发送的消息。但会出现mysql执行成功，消息发送失败的问题，但mq其实不容易失败。

### 较差一致性标准

mysql使用事务，发送多条普通消息。

缺点：之所以限制发送一条普通消息，因为多条消息，前一条一旦发送了，后一条发送失败也没法撤回，但相比较下mq还是比较稳定的，发送失败的可能性很小。

### 很差一致性标准

mysql不使用事务，发送普通消息

缺点：没有事务管理，任何一步出错都无法回滚，但很多场景对一致性要求没那么高，设计相关补偿逻辑即可。

### 隐藏问题

mysql回滚失败，但mysql的一般只有非事务回滚才会失败。mysql的回滚机制还是很完善的，除非是mysql已经物理上或者完全不可用了，不然都可以回滚。